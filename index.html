<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Donation Form</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/contentment-org/crypto-donations@main/donation.css">
    <script src="https://cdn.jsdelivr.net/gh/contentment-org/crypto-donations@main/donation.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.3/dist/web3.min.js"></script>
</head>

<body>
    <div class="donation-container">
        <h1>Donate with Crypto</h1>
        <form id="donation-form">
            <label for="donation-type">Donation Type:</label>
            <select id="donation-type" name="donation-type">
                <option value="ETH">ETH</option>
                <option value="ERC20">ERC20</option>
            </select>

            <label for="token-address" class="erc20-field">ERC20 Token Address:</label>
            <input type="text" id="token-address" name="token-address" class="erc20-field"
                placeholder="0xYourERC20TokenAddress">

            <label for="donor-email">Email:</label>
            <input type="email" id="donor-email" name="donor-email" placeholder="donor@example.com" required>

            <label for="amount">Amount:</label>
            <input type="number" step="0.01" id="amount" name="amount" placeholder="0.1" required>

            <button type="submit">Donate</button>
        </form>
        <p id="donation-status"></p>
    </div>

    <script>
        // Replace this with your Donation contract ABI
        const DonationABI = [
            /* Paste the Donation ABI here */
        ];

        // Replace this with your Donation contract address
        const DonationAddress = "0xYourDonationContractAddress";

        // ERC20 Standard ABI (minimal)
        const ERC20ABI = [
            {
                "constant": true,
                "inputs": [{ "name": "_owner", "type": "address" }],
                "name": "balanceOf",
                "outputs": [{ "name": "balance", "type": "uint256" }],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "decimals",
                "outputs": [{ "name": "", "type": "uint8" }],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "name",
                "outputs": [{ "name": "", "type": "string" }],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "symbol",
                "outputs": [{ "name": "", "type": "string" }],
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    { "name": "_spender", "type": "address" },
                    { "name": "_value", "type": "uint256" }
                ],
                "name": "approve",
                "outputs": [{ "name": "success", "type": "bool" }],
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    { "name": "_from", "type": "address" },
                    { "name": "_to", "type": "address" },
                    { "name": "_value", "type": "uint256" }
                ],
                "name": "transferFrom",
                "outputs": [{ "name": "success", "type": "bool" }],
                "type": "function"
            }
        ];

        document.addEventListener("DOMContentLoaded", () => {
            const donationForm = document.getElementById("donation-form");
            const donationTypeSelect = document.getElementById("donation-type");
            const erc20Fields = document.querySelectorAll(".erc20-field");
            const donationStatus = document.getElementById("donation-status");

            // Show/hide ERC20 fields based on the selected donation type
            donationTypeSelect.addEventListener("change", () => {
                const donationType = donationTypeSelect.value;
                erc20Fields.forEach(field => {
                    field.style.display = donationType === "ERC20" ? "block" : "none";
                });
            });

            // Handle form submission
            donationForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                donationStatus.textContent = "Processing...";

                const donationType = donationTypeSelect.value;
                const email = document.getElementById("donor-email").value;
                const amount = parseFloat(document.getElementById("amount").value);
                const account = (await ethereum.request({ method: 'eth_requestAccounts' }))[0];

                // Initialize Web3
                const web3 = new Web3(Web3.givenProvider);
                const donationContract = new web3.eth.Contract(DonationABI, DonationAddress);
                const message = web3.utils.soliditySha3({ type: "string", value: email }, { type: "address", value: account });
                const signature = await web3.eth.personal.sign(message, account);

                try {
                    if (donationType === "ETH") {
                        // Donate with ETH
                        const donationValue = web3.utils.toWei(amount.toString(), "ether");
                        await donationContract.methods.donateETH(email, signature).send({ from: account, value: donationValue });
                    } else if (donationType === "ERC20") {
                        // Donate with ERC20
                        const tokenAddress = document.getElementById("token-address").value;
                        const erc20Token = new web3.eth.Contract(ERC20ABI, tokenAddress);
                        const donationValue = web3.utils.toWei(amount.toString(), "ether");

                        // Approve and then donate
                        await erc20Token.methods.approve(DonationAddress, donationValue).send({ from: account });
                        await donationContract.methods.donateERC20(tokenAddress, donationValue, email, signature).send({ from: account });
                    }
                    donationStatus.textContent = "Donation successful! Thank you!";
                } catch (error) {
                    donationStatus.textContent = `Donation failed: ${error.message}`;
                }
            });
        });
    </script>
</body>

</html>